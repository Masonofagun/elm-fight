<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" 
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <meta charset="UTF-8">
    <title>ElmFight</title>
    <script type="text/javascript" src="elm.js"></script>
</head>

<body>
    <div id="ElmFight"></div>
</body>

<script type="text/javascript">
    // Start the Elm application.
    var app = Elm.Main.init({
        node: document.getElementById('ElmFight')
    });

    // helpers for establishing websocket connection
    var conn;
    function closeConn() {
        if (!conn) {
            return;
        }
        conn.close();
        conn = null;
    }
    function subToGame(gameID, openCB) {
        if (window["WebSocket"]) {
            closeConn();
            conn = new WebSocket("ws://" + document.location.host + "/ws" + "?gameID=" + gameID);
            conn.onclose = function (evt) {
                console.log("Host closed connection!")
                app.ports.receiveConnectionLost.send("Host closed connection.")
                conn = null
            };
            conn.onmessage = function (evt) {
                app.ports.receivePushfight.send(JSON.parse(evt.data));
            };
        } else {
            alert("Your browser does not support WebSockets.")
        }
    }



    function requestStatus(gameID, cb) {
        const request = new Request('http://' + document.location.host + '/gameIDStatus?gameID='+gameID);
        fetch(request)
            .then(response => {
                if (response.status === 200) {
                    response.json()
                        .then(data => {
                            cb(data)                    
                        })
                } else {
                    throw new Error('Something went wrong on api server!');
                }
            }).catch(error => {
                console.error(error);
            });   
    }
    // console.log(app.ports)
    // Handle new game attempts
    app.ports.requestNewGame.subscribe(function(gameID) {
        requestStatus(gameID, (data) => {
            console.log("requestNewGame")
            if (data['newGameIDValid']) {
                subToGame(data['gameID'])
                conn.onopen = function () {
                    app.ports.receiveNewGame.send(data['gameID'])
                }
            }
            else {
                alert("Can't start new game with ID = " + gameID + ". ID already in use." )
            }
        })
    })

    // Handle join game attempts
    app.ports.requestJoinGame.subscribe(function(gameID) {
        console.log("requestJoinGame")
        requestStatus(gameID, (data) => {
            if (data['joinGameIDValid']) {
                subToGame(data['gameID'])
            }
            else {
                alert("Can't join game with ID = " + gameID + ". No matching game ID" )
            }
        })
    })

    // send out board updates
    app.ports.sendPushfight.subscribe(function(data) {
        console.log("sendPushfight")
        if (!conn) {
            return;
        }
        console.log("outgoing board")
        console.log(data)
        conn.send(JSON.stringify(data));
    })

    // close WS connection when exitting game
    app.ports.notifyExit.subscribe(function () {
        console.log("notifyExit")
        closeConn(false);
    })

</script>

</html>
