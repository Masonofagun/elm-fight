<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" 
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <meta charset="UTF-8">
    <title>ElmFight</title>
    <script type="text/javascript" src="ELM_SOURCE_FILE"></script>
</head>

<body>
    <div id="ElmFight"></div>
</body>

<script type="text/javascript">
    // helpers for establishing websocket connection
    var conn;
    function closeConn() {
        if (!conn) {
            return;
        }
        conn.close();
        conn = null;
    }
    function subToGame(gameID) {
        if (window["WebSocket"]) {
            closeConn();
            conn = new WebSocket("ws://" + document.location.host + "/ws" + "?gameID=" + gameID);
            conn.onclose = function (evt) {
                alert("Host closed connection!")
            };
            conn.onmessage = function (evt) {
                app.ports.receivePushfight.send(JSON.parse(evt.data));
            };
        } else {
            alert("Your browser does not support WebSockets.")
        }
    }

    // Start the Elm application.
    var app = Elm.Main.init({
        node: document.getElementById('ElmFight')
    });

    function requestStatus(gameID, cb) {
        const request = new Request(document.location.host + '/gameIDStatus?gameID='+gameID);
        fetch(request)
            .then(response => {
                if (response.status === 200) {
                    data = response.json()
                    cb(data)
                } else {
                    throw new Error('Something went wrong on api server!');
                }
            }).catch(error => {
                console.error(error);
            });   
    }
    // Handle new game attempts
    app.ports.requestNewGame.subscribe(function(gameID) {
        requestStatus(gameID, (data) => {
            if (data['newGameIDValid']) {
                app.ports.receiveNewGame.send(data['gameID'])
                subToGame(data['gameID'])
            }
            else {
                alert("Can't start new game with ID = " + gameID ". ID already in use." )
            }
        })
    })

    // Handle join game attempts
    app.ports.requestNewGame.subscribe(function(gameID) {
        requestStatus(gameID, (data) => {
            if (data['joinGameIDValid']) {
                subToGame(data['gameID'])
            }
            else {
                alert("Can't join game with ID = " + gameID ". No matching game ID" )
            }
        })
    })

    // send out board updates
    app.ports.sendPushfight.subscribe(function(data) {
        if (!conn) {
            return;
        }
        conn.send(data.stringify());
    })

    // close WS connection when exitting game
    app.ports.notifyExit.subscribe(function () {
        closeConn();
    })

</script>

</html>
